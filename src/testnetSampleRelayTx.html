<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>

	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="author" content="Joseph Chow" />
	<meta name="description" content="btc relay, bitcoin, ethereum, bitcoin relay,smart sontracts, sidechain, peg" />

	<link rel="apple-touch-icon" sizes="57x57" href="images/favicons/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="images/favicons/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/favicons/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="images/favicons/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/favicons/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="images/favicons/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="images/favicons/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="images/favicons/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="images/favicons/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="images/favicons/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="images/favicons/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="images/favicons/favicon-16x16.png">
	<link rel="manifest" href="images/favicons/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="images/favicons/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">

	<link href='https://fonts.googleapis.com/css?family=Lato:400,300,300italic,400italic,700,700italic|Montserrat:400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="css/all.min.css" type="text/css" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<!--[if lt IE 9]>
		<script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
	<![endif]-->

	<title>BTC Relay relayTx sample</title>
</head>

<body>

	<div class="side-cover-wrapper full-screen">
	</div>

	<!-- Document Wrapper -->
	<div id="wrapper" class="clearfix">

		<!-- Header -->
		<header id="header" class="nobottomborder no-sticky">

			<div id="header-wrap">

				<div class="container-fluid clearfix">

					<div id="primary-menu-trigger"><i class="icon-reorder"></i></div>

					<!-- Logo -->
          <div class="header-logos">
  					<div id="logo"></div>
            <div class="ethereum"></div>
          </div>


					<!-- Primary Navigation -->
					<nav id="primary-menu" class="style-2">

						<!--ul>
							<li><a href="#" data-scrollto="#section-about" data-easing="easeInOutExpo" data-speed="1250" data-offset="200"><div>About</div></a></li>
							<li><a href="#" data-scrollto="#section-services" data-easing="easeInOutExpo" data-speed="1250" data-offset="60"><div>Services</div></a></li>
							<li><a href="#" data-scrollto="#section-portfolio" data-easing="easeInOutExpo" data-speed="1250" data-offset="60"><div>Portfolio</div></a></li>
							<li><a href="#" data-scrollto="#section-contact" data-easing="easeInOutExpo" data-speed="1250" data-offset="60"><div>Contact</div></a></li>
						</ul-->

					</nav><!-- #primary-menu end -->

				</div>

			</div>

		</header><!-- #header end -->

		<div class="clear"></div>

		<!-- Content -->
		<section id="content">

			<div class="content-wrap">

				<div class="container-fluid page-section clearfix">

					<!-- <div class="line topmargin-lg bottommargin-lg"></div> -->

          <p class="lead">BTC Relay Morden testnet at <span id="relayAddr"></span></p>

          <p>This is a sample of calling the
            <a href="https://github.com/ethereum/btcrelay#relaytxrawtransaction-transactionindex-merklesibling-blockhash-contractaddress">relayTx </a>method on the BTC Relay contract.
						As it is, you need a testnet client configured like: <strong>geth --testnet --unlock 0 --rpc --rpcport 8545 --rpccorsdomain=* --rpcaddr localhost</strong>
          </p>

					<h2>1.</h2>
			    <div class="row">
			      <form class="form">
			        <div class="form-group">
			          <label for="transHex">Bitcoin Transaction Hash</label>
			          <input type="text" class="form-control" id="transHex" size="64" maxlength="64"></input>
			        </div>
			        <button type="button" class="btn btn-default" id="btn-get-tx">Lookup</button>
			      </form>
			    </div>

			    <h2>2.</h2>
			    <div class="row">
			      <form>
			        <div class="form-group">
			          <label for="txHexText">Raw Transaction</label>
			          <textarea readonly class="form-control" name="textarea" id="txHexText" rows="6" cols="50"></textarea>
			        </div>

			        <div class="form-group">
			          <label for="mProof">Merkle Proof</label>
			          <textarea readonly class="form-control" name="textarea" id="mProof" rows="6" cols="50"></textarea>
			        </div>

			        <div class="form-group">
			          <label class="col-md-1 control-label">Block Hash</label>
			          <div class="col-md-9">
			            <p class="form-control-static" id="txBlockHash">0</p>
			          </div>
			        </div>
			        <br><br><br>
			        <button type="button" class="btn btn-default" onclick="callContract();">send transaction relayTx</button>
			      </form>
			    </div>

			    <div class="row">
			      <div>BTC Relay Ethereum tx hash: <span id="result"></span></div>
			    </div>

					<div class="row">
						When this tx is mined, check the <a href="https://morden.ether.camp/account/59c9fb53d658b15a7dded65c693703baf58cf63c">
						BitcoinProcessor</a> sample contract.  In its storage, the lastTxHash
						value should be the same as your input, and ethBlock block will be the
						mined Ethereum block number.  If morden.ether.camp isn't running,
						you can use web3.eth.getStorageAt('0x59c9fb53d658b15a7dded65c693703baf58cf63c', 0)
						and web3.toDecimal(web3.eth.getStorageAt('0x59c9fb53d658b15a7dded65c693703baf58cf63c', 0))
						to look up the values in storage.
					</div>
					<div class="row">
						This example shows the use of a BitcoinProcessor contract, which receives
						Bitcoin transactions via relayTx.  This is the easiest way to use BTC Relay
						because it does not need a stub, whereas using the verifyTx API in a contract
						will require a stub.
						</thead>
					</div>

				</div>

        <div class="line"></div>

				<div class="container-fluid page-section">
          <div>View page source to see the main steps:</div>
          <ul>
            <li>Getting a raw transaction from a hash</li>
            <li>Using <a href="https://www.npmjs.com/package/bitcoin-proof">bitcoin-proof </a>to get a Merkle proof</li>
            <li>Sending a transaction to <a href="https://github.com/ethereum/btcrelay#relaytxrawtransaction-transactionindex-merklesibling-blockhash-contractaddress">relayTx</a></li>
          </ul>
        </div>

			</div>

		</section><!-- #content end -->

		<!-- Footer -->
		<footer id="footer" class="dark">
			<div id="copyrights" style="background-color:#111;">
				<div class="container-fluid">
					BTC Relay is licensed under the <a href="https://github.com/ethereum/btcrelay/blob/master/LICENSE" target="_blank">MIT License</a>
				</div>
			</div>
		</footer><!-- #footer end -->

	</div><!-- #wrapper end -->

	<!-- Footer Scripts  -->
  <script type="text/javascript" src="js/all.min.js"></script>
  <script type="text/javascript">
	var web3 = require('web3');
      web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));
      // web3.eth.coinbase should be unlocked and rpccorsdomain should be * for this sample

  var btcproof = require('bitcoin-proof');

  var gRelayAddr = '0x5770345100a27b15f5b40bec86a701f888e8c601';  // testnet Morden

  // source code of processor contract is BitcoinProcessor.sol
  var gProcessorAddr = '0x59c9fb53d658b15a7dded65c693703baf58cf63c'; // testnet Morden

  var gMerkleProof;
  var gBlockHashOfTx;


  function doRelayTx(txBytes, txIndex, merkleSibling, txBlockHash) {
    var RelayContract = web3.eth.contract(btcRelayAbi);  // see ./js/btcRelayAbi.js
    var contract = RelayContract.at(gRelayAddr);

    var ethFeeToPay = web3.toWei('0.2', 'ether');  // open relayContractStatus.html to check current fee
    var objParam = { from: web3.eth.coinbase, value: ethFeeToPay, gas: 1900000 };

    var ethTx = contract.relayTx.sendTransaction(txBytes, txIndex, merkleSibling, txBlockHash, gProcessorAddr, objParam);
    document.getElementById('result').innerText = ethTx;
    // console.log('@@@ relayTx receipt: ', receipt)
    // when the tx is mined, the storage of gProcessorAddr at key0 will have
    // the Bitcoin transaction hash
  }

  function callContract() {
    var txBytes = '0x' + $('#txHexText').val();
    var txBlockHash = '0x' + gBlockHashOfTx;

    // web3.js wants 0x prepended
    var merkleSibling = gMerkleProof.sibling.map(function(sib) {
      return '0x' + sib;
    });

    doRelayTx(txBytes, gMerkleProof.txIndex, merkleSibling, txBlockHash);
  }

  // includes sample of using the bitcoin-proof module
  function getTxInfo() {
    var txid = $('#transHex').val();
    var urlJsonTx = "https://btc.blockr.io/api/v1/tx/raw/" + txid;
    $.getJSON(urlJsonTx, function(data) {
        var rawTx = data.data.tx.hex;
        $('#txHexText').val(rawTx);

        var blockNum = data.data.tx.blockhash;
        var blockInfoUrl = "//btc.blockr.io/api/v1/block/raw/"+blockNum;
        $.getJSON(blockInfoUrl, function(res) {
            gBlockHashOfTx = res.data.hash;
            $('#txBlockHash').text(gBlockHashOfTx)

            var txIndex;
            for (var key in res.data.tx) {
              if (res.data.tx[key] == txid) {
                txIndex = key;
                break;
              }
            }

            gMerkleProof = btcproof.getProof(res.data.tx, txIndex);
            console.log('merkle proof: ', gMerkleProof)
            $('#mProof').val(JSON.stringify(gMerkleProof));
        })
    })
  }

  $(function() {
    // tx[1] of block 408000
    $('#transHex').val('dd059634699e85b51af4964ab97d5e75fb7cd86b748d0ee1c537ca1850101dc7');
    $('#btn-get-tx').click(getTxInfo);
    $('#relayAddr').text(gRelayAddr);
  });
  </script>

	<!-- GA  -->
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69981046-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>
